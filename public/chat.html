<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureComm - Chat</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image:
                linear-gradient(rgba(74, 222, 128, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(74, 222, 128, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none; z-index: -1;
        }

        /* Header */
        .header {
            position: fixed; top: 0; width: 100%; height: 80px;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px);
            z-index: 1000; display: flex; justify-content: space-between;
            align-items: center; padding: 0 30px;
            border-bottom: 3px solid rgba(74, 222, 128, 0.4);
        }

        .logo {
            font-size: 24px; font-weight: bold; color: #4ade80;
            text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
        }

        .header-nav { display: flex; gap: 15px; }

        .nav-btn {
            padding: 8px 20px; border: 2px solid #4ade80; background: transparent;
            color: #4ade80; border-radius: 6px; cursor: pointer; font-weight: bold;
            font-family: 'Courier New', monospace; text-transform: uppercase;
            letter-spacing: 1px; transition: all 0.3s ease; font-size: 12px;
        }

        .nav-btn:hover {
            background: rgba(74, 222, 128, 0.15);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.4);
            transform: translateY(-2px);
        }
        
        /* Main Container */
        .main-container { display: flex; height: calc(100vh - 80px); margin-top: 80px; }
        .main-content { flex: 1; display: flex; }

        /* Chat Interface Styles */
        .chat-container { display: flex; height: 100%; width: 100%; }
        .chat-list { width: 320px; background: rgba(0, 0, 0, 0.6); border-right: 2px solid rgba(74, 222, 128, 0.3); display: flex; flex-direction: column; }
        .search-section { padding: 15px; border-bottom: 1px solid rgba(74, 222, 128, 0.3); }
        .search-input { width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.8); border: 2px solid rgba(74, 222, 128, 0.3); border-radius: 20px; color: #fff; font-size: 14px; outline: none; font-family: 'Courier New', monospace; }
        .chat-items { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-items::-webkit-scrollbar { width: 6px; }
        .chat-items::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
        .chat-items::-webkit-scrollbar-thumb { background: rgba(74, 222, 128, 0.6); }
        .chat-item { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid transparent; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s ease; }
        .chat-item:hover, .chat-item.active { background: rgba(74, 222, 128, 0.1); border-color: rgba(74, 222, 128, 0.5); }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; background: rgba(74, 222, 128, 0.3); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: #4ade80; flex-shrink: 0; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-size: 14px; font-weight: bold; color: #e2e8f0; margin-bottom: 4px; }
        .chat-preview { font-size: 12px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-meta { text-align: right; }
        .chat-time { font-size: 10px; color: #64748b; margin-bottom: 8px; }
        .unread-badge { background: #4ade80; color: #000; font-size: 10px; font-weight: bold; padding: 3px 6px; border-radius: 10px; }
        .chat-window { flex: 1; display: flex; flex-direction: column; background: rgba(0, 0, 0, 0.4); }
        .chat-placeholder { flex: 1; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 1.2em; }
        .chat-header { padding: 20px; border-bottom: 2px solid rgba(74, 222, 128, 0.3); background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; gap: 15px; justify-content: space-between;}
        .chat-title { font-size: 18px; font-weight: bold; color: #4ade80; }
        .chat-status { font-size: 12px; color: #94a3b8; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(74, 222, 128, 0.6); }
        .message { max-width: 70%; padding: 12px 18px; border-radius: 18px; font-size: 14px; line-height: 1.5; position: relative; }
        .message.sent { align-self: flex-end; background: linear-gradient(45deg, #4ade80, #22d3ee); color: #000; border-bottom-right-radius: 5px; }
        .message.received { align-self: flex-start; background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); color: #e2e8f0; border-bottom-left-radius: 5px; }
        .message-time { font-size: 10px; opacity: 0.7; margin-top: 5px; display: block; }
        .chat-input-section { padding: 20px; border-top: 2px solid rgba(74, 222, 128, 0.3); background: rgba(0, 0, 0, 0.6); }
        .chat-input-container { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; background: rgba(0, 0, 0, 0.8); border: 2px solid rgba(74, 222, 128, 0.3); border-radius: 10px; color: #fff; font-size: 14px; outline: none; font-family: 'Courier New', monospace; resize: none; }
        .send-btn { padding: 12px 20px; background: linear-gradient(45deg, #4ade80, #22d3ee); border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer; font-size: 14px; }
        
        /* --- MODIFIED/NEW STYLES --- */
        .delete-chat-btn {
            padding: 6px 12px;
            border: 2px solid #ef4444; /* Red color for delete */
            background: transparent;
            color: #ef4444;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            font-size: 10px;
            margin-left: auto; /* Push it to the right */
        }

        .delete-chat-btn:hover {
            background: rgba(239, 68, 68, 0.15); /* Red hover */
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            transform: translateY(-2px);
        }

        .message {
            position: relative; /* For positioning the delete button */
        }
        .delete-msg-btn {
            position: absolute;
            top: 2px;
            font-size: 14px;
            cursor: pointer;
            display: none; /* Hide by default */
            font-weight: bold;
            opacity: 0.7;
            padding: 0 5px;
        }
        .message:hover .delete-msg-btn {
            display: block; /* Show on hover */
        }
        .message.sent .delete-msg-btn {
            right: 8px;
            color: #555; /* Darker on the bright bubble */
        }
        /* We won't show this on received, but just in case */
        .message.received .delete-msg-btn { 
            display: none;
        }
        .delete-msg-btn:hover {
            opacity: 1;
        }
        /* --- END OF MODIFIED/NEW STYLES --- */


        /* MODAL STYLES */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); justify-content: center; align-items: center; }
        .modal-content { background: rgba(10, 10, 20, 0.95); padding: 30px; border: 2px solid #4ade80; border-radius: 15px; width: 90%; max-width: 700px; position: relative; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5); }
        .modal-content h2 { color: #4ade80; margin-bottom: 20px; text-align: center; }
        .modal-content h3 { color: #22d3ee; margin-bottom: 15px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; color: #4ade80; cursor: pointer; line-height: 1; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase; font-size: 12px; }
        .form-textarea { width: 100%; min-height: 100px; padding: 12px; background: rgba(0, 0, 0, 0.8); border: 2px solid rgba(74, 222, 128, 0.3); border-radius: 8px; color: #fff; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical; }
        .radio-group, .checkbox-group { display: flex; gap: 20px; }
        .radio-group label, .checkbox-group label { display: flex; align-items: center; cursor: pointer; color: #e2e8f0; text-transform: none; font-size: 14px; }
        input[type="radio"], input[type="checkbox"] { appearance: none; -webkit-appearance: none; width: 18px; height: 18px; border: 2px solid #4ade80; margin-right: 10px; vertical-align: middle; transition: all 0.2s; }
        input[type="radio"] { border-radius: 50%; }
        input[type="checkbox"] { border-radius: 4px; }
        input[type="radio"]:checked, input[type="checkbox"]:checked { background-color: #4ade80; box-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; }
        .modal-btn { padding: 10px 25px; border-radius: 6px; font-weight: bold; font-family: 'Courier New', monospace; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; }
        .btn-send { background: #4ade80; color: #000; border: none; }
        .btn-cancel { background: transparent; color: #ef4444; border: 2px solid #ef4444; }
        
        #intraUnitSelectModal .modal-content, #interUnitSelectModal .modal-content { max-width: 400px; }
        .recipients-list { max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.4); border-radius: 8px; }
        .recipient-item { margin-bottom: 10px; }
        
        .btn-done { background: linear-gradient(45deg, #22d3ee, #4ade80); color: #000; border: none; }
        .btn-done:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(34, 211, 238, 0.4); }
        .btn-done:disabled { background: #555; color: #888; cursor: not-allowed; opacity: 0.5; box-shadow: none; transform: none; }

        .modal-btn:hover { transform: translateY(-2px); }
        .btn-send:hover { box-shadow: 0 5px 15px rgba(74, 222, 128, 0.4); }
        .btn-cancel:hover { background: rgba(239, 68, 68, 0.1); box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4); }
        
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">SecureComm Command</div>
        <div class="header-nav">
            <a href="main.html"><button class="nav-btn">Back to Dashboard</button></a>
            <button class="nav-btn" onclick="openPostQuestionModal()">Hierarchy</button>
        </div>
    </div>

    <div class="main-container">
        <div class="main-content">
            <div class="chat-container">
                <div class="chat-list">
                    <div class="search-section">
                        <input type="text" class="search-input" placeholder="Search by Service-Id">
                    </div>
                    <div class="chat-items">
                        </div>
                </div>
                <div class="chat-window">
                    <div class="chat-placeholder"><p>Select a contact to view messages</p></div>
                    <div class="chat-header" style="display: none;">
                        <div class="chat-avatar" id="chat-header-avatar"></div>
                        <div>
                            <div class="chat-title" id="chat-title"></div>
                            <div class="chat-status" id="chat-status"></div>
                        </div>
                        <button class="delete-chat-btn" id="deleteChatBtn" title="Hide this conversation">Hide</button> </div>
                    <div class="chat-messages" style="display: none;"></div>
                    <div class="chat-input-section" style="display: none;">
                        <div class="chat-input-container">
                            <textarea class="chat-input" placeholder="Type your message..."></textarea>
                            <button class="send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="postQuestionModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePostQuestionModal()">&times;</span>
            <h2>Post a Message or Question</h2>
            <div class="form-group"><label for="messageText">Message:</label><textarea id="messageText" class="form-textarea" placeholder="Type your message..."></textarea></div>
            <div class="form-group"><label>Post As:</label><div class="radio-group"><label><input type="radio" name="anonymity" value="public" checked> Not Anonymous</label><label><input type="radio" name="anonymity" value="anonymous"> Anonymous</label></div></div>
            <div class="form-group"><label>Visible To:</label><div class="checkbox-group"><label><input type="checkbox" id="interUnitCheckbox"> Inter-Unit</label><label><input type="checkbox" id="intraUnitCheckbox"> Intra-Unit</label></div></div>
            <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closePostQuestionModal()">Cancel</button><button class="modal-btn btn-send" onclick="submitQuestion()">Send</button></div>
        </div>
    </div>
    <div class="modal" id="intraUnitSelectModal">
        <div class="modal-content">
            <h3>Select Intra-Unit Recipients</h3>
            <div class="recipients-list">
                <div class="recipient-item checkbox-group"><label><input type="checkbox" value="p1" class="recipient-checkbox"> SGT. Mike Ross</label></div>
                <div class="recipient-item checkbox-group"><label><input type="checkbox" value="p2" class="recipient-checkbox"> LT. John Smith</label></div>
                <div class="recipient-item checkbox-group"><label><input type="checkbox" value="p3" class="recipient-checkbox"> CPT. Sarah Connor</label></div>
                <div class="recipient-item checkbox-group"><label><input type="checkbox" value="p4" class="recipient-checkbox"> PFC. Jane Doe</label></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="cancelIntraUnitSelection()">Cancel</button>
                <button class="modal-btn btn-done" id="intraUnitDoneBtn" onclick="closeIntraUnitModal()" disabled>Done</button>
            </div>
        </div>
    </div>
    <div class="modal" id="interUnitSelectModal">
        <div class="modal-content">
            <h3>Select Inter-Unit Recipients</h3>
            <div class="recipients-list">
                <div class="recipient-item checkbox-group"><label><input type="checkbox" value="u1" class="inter-recipient-checkbox"> Alpha Company</label></div>
                <div class="recipient-item checkbox-group"><label><input type="checkbox" value="u2" class="inter-recipient-checkbox"> Bravo Team</label></div>
                <div class="recipient-item checkbox-group"><label><input type="checkbox" value="u3" class="inter-recipient-checkbox"> Charlie Platoon</label></div>
                <div class="recipient-item checkbox-group"><label><input type="checkbox" value="u4" class="inter-recipient-checkbox"> Delta Squad</label></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="cancelInterUnitSelection()">Cancel</button>
                <button class="modal-btn btn-done" id="interUnitDoneBtn" onclick="closeInterUnitModal()" disabled>Done</button>
            </div>
        </div>
    </div>
    <script>
    // --- GLOBAL VARS ---
    let loggedInMilitaryId = null;
    let currentOpenChatId = null;
    let myPrivateKey = null; // Will hold our decrypted private key
    let keyCache = new Map(); // Caches public keys of other users

    // --- DOM ELEMENTS ---
    const chatList = document.querySelector('.chat-items');
    const chatWindow = document.querySelector('.chat-window');
    const chatPlaceholder = chatWindow.querySelector('.chat-placeholder');
    const chatHeader = chatWindow.querySelector('.chat-header');
    const chatMessages = chatWindow.querySelector('.chat-messages');
    const chatInputSection = chatWindow.querySelector('.chat-input-section');
    const sendButton = document.querySelector('.send-btn');
    const chatInput = document.querySelector('.chat-input');
    const searchInput = document.querySelector('.search-input');
    const deleteChatBtn = document.getElementById('deleteChatBtn');

    // ======================================================
    // --- START: CRYPTO FUNCTIONS (Ported from crypto-utils.js) ---
    // =Warning: This is for educational purposes and is not secure.
    // ======================================================

    // Modular exponentiation (base^exp % mod) using BigInt
    const power = (base, exp, mod) => {
        let res = 1n;
        base %= mod;
        while (exp > 0n) {
        if (exp % 2n === 1n) res = (res * base) % mod;
        base = (base * base) % mod;
        exp /= 2n;
        }
        return res;
    };

    // Miller-Rabin primality test
    const isProbablyPrime = (n, k = 5) => {
        if (n <= 1n || n === 4n) return false;
        if (n <= 3n) return true;
        let d = n - 1n;
        while (d % 2n === 0n) d /= 2n;
        for (let i = 0; i < k; i++) {
        const a = 2n + BigInt(Math.floor(Math.random() * Number(n - 4n)));
        let x = power(a, d, n);
        if (x === 1n || x === n - 1n) continue;
        let isWitness = true;
        let tempD = d;
        while (tempD < n - 1n) {
            x = (x * x) % n;
            if (x === n - 1n) { isWitness = false; break; }
            tempD *= 2n;
        }
        if (isWitness) return false;
        }
        return true;
    };

    // Extended Euclidean Algorithm
    const extendedEuclideanAlgorithm = (a, b) => {
        if (a === 0n) return [b, 0n, 1n];
        const [gcd, x1, y1] = extendedEuclideanAlgorithm(b % a, a);
        const x = y1 - (b / a) * x1;
        const y = x1;
        return [gcd, x, y];
    };

    const modInverse = (a, m) => {
        const [gcd, x] = extendedEuclideanAlgorithm(a, m);
        if (gcd !== 1n) throw new Error('Inverse does not exist');
        return (x % m + m) % m;
    };

    // Simple seeded pseudo-random number generator (LCG)
    const seededPseudoRandom = (seed) => {
        let state = seed;
        const m = 2n ** 31n - 1n;
        const a = 1103515245n;
        const c = 12345n;
        return () => {
        state = (a * state + c) % m;
        return state;
        };
    };

    // Function to find a prime
    const findPrime = (bits, prng) => {
        const min = 2n ** (BigInt(bits) - 1n);
        const max = 2n ** BigInt(bits) - 1n;
        while (true) {
        const p = (prng() % (max - min)) + min;
        if (p % 2n !== 0n && isProbablyPrime(p)) return p;
        }
    };

    // Main key generation function
    const generateKeys = (password, salt, bits = 64) => {
        let seed = 1n;
        const combined = password + salt;
        for (let i = 0; i < combined.length; i++) {
        seed = (seed * 31n + BigInt(combined.charCodeAt(i))) % (2n ** 31n - 1n);
        }
        const prng = seededPseudoRandom(seed);
        let p = findPrime(bits, prng);
        let q = findPrime(bits, prng);
        while (p === q) q = findPrime(bits, prng);
        const n = p * q;
        const phi_n = (p - 1n) * (q - 1n);
        const e = 65537n;
        const d = modInverse(e, phi_n);
        return {
        publicKey: { n, e },
        privateKey: { n, d },
        };
    };

    /**
     * Encrypts a string using RSA (char by char - INSECURE).
     * @param {string} plaintext The message to encrypt.
     * @param {object} publicKey {n: string, e: string}
     * @returns {string} Comma-separated list of encrypted char codes.
     */
    function encryptMessage(plaintext, publicKey) {
        const e = BigInt(publicKey.e);
        const n = BigInt(publicKey.n);
        let cipherParts = [];
        for (let i = 0; i < plaintext.length; i++) {
            const charCode = BigInt(plaintext.charCodeAt(i));
            const encryptedChar = power(charCode, e, n);
            cipherParts.push(encryptedChar.toString());
        }
        return cipherParts.join(',');
    }

    /**
     * Decrypts an RSA-encrypted string (char by char).
     * @param {string} ciphertext Comma-separated list of encrypted char codes.
     * @param {object} privateKey {n: BigInt, d: BigInt}
     * @returns {string} The decrypted plaintext.
     */
    function decryptMessage(ciphertext, privateKey) {
        const d = privateKey.d;
        const n = privateKey.n;
        let plain = '';
        const cipherParts = ciphertext.split(',');
        for (const part of cipherParts) {
            if (part === '') continue;
            const charCode = BigInt(part);
            const decryptedChar = power(charCode, d, n);
            plain += String.fromCharCode(Number(decryptedChar));
        }
        return plain;
    }

    /**
     * Helper to fetch and cache public keys.
     */
    async function fetchKey(militaryId) {
        if (keyCache.has(militaryId)) {
            return keyCache.get(militaryId);
        }
        const response = await fetch(`/api/profile/key/${militaryId}`);
        const data = await response.json();
        if (!data.success) throw new Error(data.error);
        keyCache.set(militaryId, data.publicKey);
        return data.publicKey;
    }

    // ======================================================
    // --- END: CRYPTO FUNCTIONS ---
    // ======================================================

    /**
     * Runs when the page is loaded.
     */
    document.addEventListener('DOMContentLoaded', async function() {
        // --- HIERARCHY MODAL SCRIPT ---
        setupModalListeners();

        // --- CHAT SCRIPT ---
        loggedInMilitaryId = localStorage.getItem('militaryId');
        if (!loggedInMilitaryId) {
            chatPlaceholder.innerHTML = '<p>Error: Not logged in. Please <a href="/login">log in</a>.</p>';
            return;
        }
        console.log(`Logged in as: ${loggedInMilitaryId}`);

        // --- RE-GENERATE PRIVATE KEY ---
        try {
            const sessionStr = sessionStorage.getItem('activeSession');
            if (!sessionStr) throw new Error('Active session not found. Please log in again.');
            
            const session = JSON.parse(sessionStr);
            const myPassword = session.password;
            const mySalt = session.profile.salt;

            if (!myPassword || !mySalt) {
                throw new Error('Session is missing password or salt. Please log in again.');
            }

            console.log('ðŸ”‘ Re-generating private key from password and salt...');
            const { privateKey } = generateKeys(myPassword, mySalt);
            myPrivateKey = privateKey; // Store it in our global variable
            console.log('âœ… Private key re-generated successfully.');

        } catch (error) {
            console.error('CRITICAL: Could not generate private key.', error);
            chatPlaceholder.innerHTML = `<p style="color: #ef4444;"><b>Fatal Error:</b> Could not initialize security keys. ${error.message}</p>`;
            return;
        }
        // --- END KEY GENERATION ---

        
        await loadChatList();
        
        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', handleSearch);
        deleteChatBtn.addEventListener('click', hideCurrentChat);
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    });

    /**
     * Fetches the list of conversations from the API.
     */
    async function loadChatList() {
        try {
            const response = await fetch(`/api/chat/conversations/${loggedInMilitaryId}`);
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            chatList.innerHTML = '';
            if (data.conversations.length === 0) {
                    chatList.innerHTML = '<p style="padding: 20px; color: #64748b;">No conversations found.</p>';
            }
            data.conversations.forEach(convo => {
                const chatItem = createChatItem(convo);
                chatList.appendChild(chatItem);
            });
        } catch (error) {
            console.error('Error loading chat list:', error);
            chatList.innerHTML = `<p style="padding: 20px; color: #ef4444;">Error loading chats.</p>`;
        }
    }

    /**
     * Handles the search input field.
     */
    async function handleSearch() {
        const query = searchInput.value.trim();
        if (query === '') { await loadChatList(); return; }
        if (query.length < 2) { chatList.innerHTML = ''; return; }

        try {
            const response = await fetch(`/api/profiles/search/${loggedInMilitaryId}/${query}`);
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            chatList.innerHTML = '';
            if (data.results.length === 0) {
                chatList.innerHTML = '<p style="padding: 20px; color: #64748b;">No matching profiles found.</p>';
            } else {
                data.results.forEach(profile => {
                    const chatItem = createChatItem(profile); 
                    chatList.appendChild(chatItem);
                });
            }
        } catch (error) {
            console.error('Error during search:', error);
            chatList.innerHTML = `<p style="padding: 20px; color: #ef4444;">Error during search.</p>`;
        }
    }

    /**
     * Creates a single chat item element for the sidebar.
     */
    function createChatItem(convo) {
        const div = document.createElement('div');
        div.className = 'chat-item';
        div.dataset.contactId = convo.otherPartyId;
        const msgTime = new Date(convo.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Sanitize preview text
        const previewText = document.createTextNode(convo.lastMessage).textContent;

        div.innerHTML = `
            <div class="chat-avatar">${convo.avatar}</div>
            <div class="chat-info">
                <div class="chat-name">${convo.name}</div>
                <div class="chat-preview">${previewText}</div>
            </div>
            <div class="chat-meta">
                <div class="chat-time">${msgTime}</div>
                ${convo.unread > 0 ? `<div class="unread-badge">${convo.unread}</div>` : ''}
            </div>
        `;
        div.addEventListener('click', () => openChat(convo.otherPartyId, convo.name, convo.avatar));
        return div;
    }

    /**
         * Opens a chat window for a specific contact. (UPDATED for E2EE)
         */
        async function openChat(contactId, contactName, contactAvatar) {
            currentOpenChatId = contactId;
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.chat-item[data-contact-id='${contactId}']`).classList.add('active');

            chatPlaceholder.style.display = 'none';
            chatHeader.style.display = 'flex';
            chatMessages.style.display = 'flex';
            chatInputSection.style.display = 'block';

            document.getElementById('chat-header-avatar').textContent = contactAvatar;
            document.getElementById('chat-title').textContent = contactName;
            document.getElementById('chat-status').textContent = "Military ID";
            document.getElementById('deleteChatBtn').title = `Hide conversation with ${contactName}`;
            document.getElementById('deleteChatBtn').textContent = "Hide";

            chatMessages.innerHTML = '<p style="color: #64748b; text-align: center;">Loading & Decrypting messages...</p>';

            try {
                const response = await fetch(`/api/chat/history/${loggedInMilitaryId}/${contactId}`);
                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                chatMessages.innerHTML = ''; // Clear loading

                for (const msg of data.messages) {
                    const isSent = msg.senderId === loggedInMilitaryId;
                    const msgTime = new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    let messageText = "";
                    let allowDelete = false;

                    try {
                        if (isSent) {
                            // We sent this. Decrypt our own copy.
                            if (!msg.senderCopy) {
                                // This is an old message, from before we had this feature
                                messageText = "[Encrypted - Sent by You (Old)]";
                            } else {
                                messageText = decryptMessage(msg.senderCopy, myPrivateKey);
                            }
                            allowDelete = true; // We can always delete our own messages
                        } else {
                            // We received this. Decrypt the main text.
                            messageText = decryptMessage(msg.messageText, myPrivateKey);
                        }
                    } catch (e) {
                        console.error('Decryption failed for message:', msg._id, e);
                        messageText = "[DECRYPTION FAILED]";
                    }
                    
                    appendMessage(messageText, isSent, msgTime, msg._id, allowDelete);
                }
                
                loadChatList(); 

            } catch (error) {
                console.error('Error loading chat history:', error);
                chatMessages.innerHTML = `<p style="padding: 20px; color: #ef4444; text-align: center;">Error loading messages.</p>`;
            }
        }

        /**
         * Appends a single message bubble to the chat window.
         */
        function appendMessage(text, isSent, time, messageId, allowDelete = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = messageId; // Add ID to the element

            const safeText = document.createTextNode(text).textContent;
            
            let deleteBtnHtml = '';
            // Allow delete only if it's a "real" sent message and has an ID
            if (isSent && allowDelete && messageId) {
                 deleteBtnHtml = `<span class="delete-msg-btn" onclick="deleteSingleMessage(this, '${messageId}')" title="Delete message">&times;</span>`;
            }

            messageDiv.innerHTML = `${safeText}<span class="message-time">${time}</span>${deleteBtnHtml}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

    /**
         * Sends a new message via the API. (UPDATED for E2EE)
         */
        async function sendMessage() {
            const text = chatInput.value.trim();
            if (text === '' || !currentOpenChatId) return;

            // --- START ENCRYPTION ---
            let encryptedTextForReceiver;
            let encryptedTextForSelf; // For our own history
            
            try {
                console.log(`Fetching public key for receiver ${currentOpenChatId}...`);
                const receiverKey = await fetchKey(currentOpenChatId);
                console.log('Encrypting message for receiver...');
                encryptedTextForReceiver = encryptMessage(text, receiverKey);
                
                // Now, encrypt a copy for OURSELVES using our OWN public key
                console.log(`Fetching public key for self ${loggedInMilitaryId}...`);
                const selfKey = await fetchKey(loggedInMilitaryId); // Will be cached
                console.log('Encrypting message for self...');
                encryptedTextForSelf = encryptMessage(text, selfKey);

            } catch (error) {
                console.error('Encryption failed:', error);
                alert('Error: Could not get encryption keys. Cannot send message.');
                return;
            }
            // --- END ENCRYPTION ---

            const sentText = chatInput.value; // Store plain text
            chatInput.value = ''; 

            try {
                // --- SEND MESSAGE (with both copies) ---
                const messageData = {
                    senderId: loggedInMilitaryId,
                    receiverId: currentOpenChatId,
                    messageText: encryptedTextForReceiver, // For receiver
                    senderCopy: encryptedTextForSelf      // For self
                };
                
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageData)
                });
                
                const data = await response.json();
                if (!data.success) throw new Error(data.error);
                
                const msg = data.message;
                const msgTime = new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Append the PLAIN text for our own view
                appendMessage(sentText, true, msgTime, msg._id, true); 

                await loadChatList(); // Update sidebar

            } catch (error) {
                console.error('Error sending message:', error);
                chatInput.value = sentText; // Put failed message back
                alert('Failed to send message: ' + error.message);
            }
        }

    /**
     * Hides the currently open conversation.
     */
    async function hideCurrentChat() {
        if (!currentOpenChatId) {
            alert('No chat selected.');
            return;
        }
        const contactName = document.getElementById('chat-title').textContent;
        const isConfirmed = confirm(`Are you sure you want to HIDE your conversation with ${contactName}? The history will be removed from your view, but not for them.`);
        if (!isConfirmed) return;
        
        try {
            const response = await fetch(`/api/chat/hide`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    myId: loggedInMilitaryId,
                    otherId: currentOpenChatId
                })
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            
            console.log(`Successfully hid ${data.hiddenCount} messages.`);
            chatHeader.style.display = 'none';
            chatMessages.style.display = 'none';
            chatInputSection.style.display = 'none';
            chatPlaceholder.style.display = 'flex';
            currentOpenChatId = null;
            await loadChatList();

        } catch (error) {
            console.error('Error hiding chat:', error);
            alert('Failed to hide chat: ' + error.message);
        }
    }
    
    /**
     * Deletes a single message from the database.
     */
    async function deleteSingleMessage(buttonElement, messageId) {
        if (!confirm('Are you sure you want to PERMANENTLY delete this message? This cannot be undone.')) {
            return;
        }
        try {
            const response = await fetch('/api/chat/message', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messageId: messageId,
                    myId: loggedInMilitaryId
                })
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            const messageDiv = buttonElement.closest('.message');
            if (messageDiv) messageDiv.remove();
            await loadChatList();

        } catch (error) {
            console.error('Error deleting message:', error);
            alert('Failed to delete message: ' + error.message);
        }
    }
    
    // ======================================================
    // --- HIERARCHY / POSTING MODAL SCRIPT (Unchanged) ---
    // ======================================================
    const postQuestionModal = document.getElementById('postQuestionModal');
    const intraUnitSelectModal = document.getElementById('intraUnitSelectModal');
    const intraUnitCheckbox = document.getElementById('intraUnitCheckbox');
    const interUnitSelectModal = document.getElementById('interUnitSelectModal');
    const interUnitCheckbox = document.getElementById('interUnitCheckbox');
    function setupModalListeners() {
        const recipientCheckboxes = document.querySelectorAll('.recipient-checkbox');
        const intraUnitDoneBtn = document.getElementById('intraUnitDoneBtn');
        function updateDoneButtonState() {
            const anyChecked = Array.from(recipientCheckboxes).some(checkbox => checkbox.checked);
            intraUnitDoneBtn.disabled = !anyChecked;
        }
        recipientCheckboxes.forEach(checkbox => checkbox.addEventListener('change', updateDoneButtonState));
        const interRecipientCheckboxes = document.querySelectorAll('.inter-recipient-checkbox');
        const interUnitDoneBtn = document.getElementById('interUnitDoneBtn');
        function updateInterDoneButtonState() {
            const anyChecked = Array.from(interRecipientCheckboxes).some(checkbox => checkbox.checked);
            interUnitDoneBtn.disabled = !anyChecked;
        }
        interRecipientCheckboxes.forEach(checkbox => checkbox.addEventListener('change', updateInterDoneButtonState));
        intraUnitCheckbox.addEventListener('change', function() { if (this.checked) openIntraUnitModal(); });
        interUnitCheckbox.addEventListener('change', function() { if (this.checked) openInterUnitModal(); });
    }
    function openPostQuestionModal() { postQuestionModal.style.display = 'flex'; }
    function closePostQuestionModal() { postQuestionModal.style.display = 'none'; }
    function submitQuestion() {
        const messageText = document.getElementById('messageText').value.trim();
        if (messageText === '') { alert('Please enter a message before sending.'); return; }
        const isInterUnitChecked = document.getElementById('interUnitCheckbox').checked;
        const isIntraUnitChecked = document.getElementById('intraUnitCheckbox').checked;
        if (!isInterUnitChecked && !isIntraUnitChecked) { alert('Please select who the message is visible to (Inter-Unit or Intra-Unit).'); return; }
        alert('Message Sent (simulation).');
        closePostQuestionModal();
    }
    function openIntraUnitModal() { intraUnitSelectModal.style.display = 'flex'; }
    function closeIntraUnitModal() { intraUnitSelectModal.style.display = 'none'; }
    function openInterUnitModal() { interUnitSelectModal.style.display = 'flex'; }
    function closeInterUnitModal() { interUnitSelectModal.style.display = 'none'; }
    function cancelIntraUnitSelection() { document.getElementById('intraUnitCheckbox').checked = false; closeIntraUnitModal(); }
    function cancelInterUnitSelection() { document.getElementById('interUnitCheckbox').checked = false; closeInterUnitModal(); }
</script>
</body>
</html>